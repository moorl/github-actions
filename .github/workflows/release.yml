name: Store Release
on:
  workflow_call:
    inputs:
      extensionName:
        required: true
        type: string
      publishShopwareStore:
        required: false
        type: string
        default: 'false'
      cliVersion:
        description: 'The shopware-cli version to build the extension with'
        required: false
        type: string
        default: 'latest'
      path:
        description: "Path to your bundle"
        required: false
        type: string
        default: "."
      environment:
        description: "The environment to use"
        required: false
        type: string
        default: ""
    secrets:
      accountUser:
        required: false
      accountPassword:
        required: false
      ghToken:
        required: true

jobs:
  preflight:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.read.outputs.version }}
      tag_exists: ${{ steps.tagcheck.outputs.exists }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Version NUR aus composer.json (unter inputs.path) lesen
      - name: Read version from composer.json
        id: read
        shell: bash
        run: |
          set -euo pipefail
          FILE="${{ inputs.path%/ }}/composer.json"
          if [[ ! -f "$FILE" ]]; then
            echo "::error::composer.json not found at $FILE"
            exit 1
          fi
          ver=$(jq -r '.version // empty' "$FILE")
          if [[ -z "$ver" ]]; then
            echo "::error::No 'version' field in $FILE"
            exit 1
          fi
          echo "Using version: $ver"
          echo "version=$ver" >> "$GITHUB_OUTPUT"

      # PrÃ¼fen, ob Tag mit genau dieser Version existiert
      - name: Check tag existence
        id: tagcheck
        uses: mukunku/tag-exists-action@v1.6.0
        with:
          tag: ${{ steps.read.outputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.ghToken }}

  BuildAndRelease:
    needs: preflight
    if: ${{ needs.preflight.outputs.tag_exists != 'true' }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    env:
      EXTENSION_VERSION: ${{ needs.preflight.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install shopware-cli
        uses: shopware/shopware-cli-action@v1
        with:
          version: ${{ inputs.cliVersion }}

      - name: Prepare names
        run: |
          echo "ZIP_NAME=${{ inputs.extensionName }}-${EXTENSION_VERSION}.zip" >> "$GITHUB_ENV"

      - name: Build & create zip
        env:
          NODE_OPTIONS: --openssl-legacy-provider
        run: |
          shopware-cli extension zip --git-commit ${{ github.sha }} "${{ inputs.path }}" --release
          mv "${{ inputs.extensionName }}-${{ github.sha }}.zip" "${ZIP_NAME}"
          echo "Built ${ZIP_NAME}"

      - name: Upload Artefact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.extensionName }}-${{ env.EXTENSION_VERSION }}
          path: ${{ env.ZIP_NAME }}

      - name: Validate Zip
        run: shopware-cli extension validate "$(pwd)/${ZIP_NAME}"

      - name: Store Upload
        if: ${{ env.PUBLISH_SHOPWARE_STORE == 'true' }}
        run: shopware-cli account producer extension upload "$(pwd)/${ZIP_NAME}"
        env:
          GITHUB_TOKEN: ${{ secrets.ghToken }}
          SHOPWARE_CLI_ACCOUNT_EMAIL: ${{ secrets.accountUser }}
          SHOPWARE_CLI_ACCOUNT_PASSWORD: ${{ secrets.accountPassword }}
          PUBLISH_SHOPWARE_STORE: ${{ inputs.publishShopwareStore == 'true' && secrets.accountUser != '' && secrets.accountPassword != '' }}

      - name: Extract Changelog
        run: shopware-cli extension get-changelog "$(pwd)/${ZIP_NAME}" > /tmp/changelog.txt

      - name: Unzip
        run: |
          unzip -o -q "${ZIP_NAME}" -d /tmp/toDeploy
          mv "${ZIP_NAME}" /tmp/
          rsync -av --exclude '.git' --delete "/tmp/toDeploy/${{ inputs.extensionName }}/" .
          rm -rf ./vendor

      - name: Commit & tag
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "<>"
          git add -f .
          git commit -m "Build release" || echo "No changes to commit"
          git tag "${EXTENSION_VERSION}"
          git push origin "${EXTENSION_VERSION}"

      - name: Create a GitHub release
        uses: ncipollo/release-action@v1
        with:
          artifacts: /tmp/${{ env.ZIP_NAME }}
          tag: ${{ env.EXTENSION_VERSION }}
          name: ${{ env.EXTENSION_VERSION }}
          bodyFile: /tmp/changelog.txt
